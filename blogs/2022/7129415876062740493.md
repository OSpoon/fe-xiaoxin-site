---
title: ã€Serverlessã€‘å‰ç«¯ä¸Š Ali äº‘å¿…å¤‡æŒ‡å— 
date: '2022-08-08 16:14'
sidebar: 'auto'
categories:
 - å®æˆ˜æ¡ˆä¾‹
tags:
 - Serverless
 - å¾®ä¿¡SDKæˆæƒ
 - Node
---

:::tip
åŸæœ¬æ—©å°±è¯¥å†™å®Œäº†å¾®ä¿¡ SDK æˆæƒæœåŠ¡ä¸Šäº‘è®¡åˆ’ç”±äºå¯¹ Ali äº‘å‡½æ•°è®¡ç®— FC çš„ä¸ç†Ÿæ‚‰é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œå†å‰é¢çš„æ–‡ç« ä¸­è¿˜åæ§½äº†ä¸€é€šã€‚åœ¨æœåŠ¡é¡ºåˆ©è·‘é€šåï¼Œè¿™å›å®æ‰“å®çš„æ¥æ€»ç»“ä¸€ä¸‹é¡ºåˆ©ä¸Šäº‘çš„ä¿å®ˆæŒ‡å—~
:::

<!-- more -->

## 1. å‰è¨€
------

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[å°é‘«åŒå­¦](https://juejin.cn/user/3966693685871694 "https://juejin.cn/user/3966693685871694")ã€‚ä¸€ä½ä»äº‹è¿‡**Androidå¼€å‘**ã€**æ··åˆå¼€å‘**ï¼Œç°åœ¨é•¿æœŸä»äº‹**å‰ç«¯å¼€å‘**çš„ç¼–ç¨‹çˆ±å¥½è€…ï¼Œ**æˆ‘è§‰å¾—åœ¨ç¼–ç¨‹ä¹‹è·¯ä¸Šæœ€é‡è¦çš„æ˜¯çŸ¥è¯†çš„åˆ†äº«ï¼Œæ‰€è°“ä¸‰äººè¡Œå¿…æœ‰æˆ‘å¸ˆ**ã€‚æ‰€ä»¥æˆ‘å¼€å§‹åœ¨ç¤¾åŒºæŒç»­è¾“å‡ºæˆ‘æ‰€äº†è§£åˆ°ã€å­¦ä¹ åˆ°ã€å·¥ä½œä¸­é‡åˆ°çš„å„ç§ç¼–ç¨‹çŸ¥è¯†ï¼Œæ¬¢è¿æœ‰æƒ³æ³•ã€æœ‰åŒæ„Ÿçš„ä¼™ä¼´åŠ æˆ‘[fe-xiaoxin](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")å¾®ä¿¡äº¤æµ~

åŸæœ¬æ—©å°±è¯¥å†™å®Œäº†å¾®ä¿¡ SDK æˆæƒæœåŠ¡ä¸Šäº‘è®¡åˆ’ç”±äºå¯¹ Ali äº‘å‡½æ•°è®¡ç®— FC çš„ä¸ç†Ÿæ‚‰é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œå†å‰é¢çš„æ–‡ç« ä¸­è¿˜åæ§½äº†ä¸€é€šã€‚åœ¨æœåŠ¡é¡ºåˆ©è·‘é€šåï¼Œè¿™å›å®æ‰“å®çš„æ¥æ€»ç»“ä¸€ä¸‹é¡ºåˆ©ä¸Šäº‘çš„ä¿å®ˆæŒ‡å—~

## 2. åˆ›å»ºå‡½æ•°è®¡ç®—åº”ç”¨/æœåŠ¡/å‡½æ•°
------------------

> é¡¹ç›®åŸºäº Node.js æŠ€æœ¯æ ˆçš„ egg.js æœåŠ¡ç«¯é¡¹ç›®æ¨¡æ¿æ­å»ºæˆæƒæœåŠ¡

### 2.1 é€‰æ‹©æœåŠ¡æ¨¡æ¿ï¼š

ç™»é™†Ali[äº‘å‡½æ•°è®¡ç®— FC åº”ç”¨](https://link.juejin.cn/?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Fapplications "https://fcnext.console.aliyun.com/applications")æ§åˆ¶å°ï¼Œé€‰æ‹©ã€é€šè¿‡æ¨¡æ¿åˆ›å»ºåº”ç”¨ã€‘ï¼Œåœ¨ä¸‹é¢çš„é€‰é¡¹é€‰ä¸­Webå¼€å‘æ¡†æ¶åæœç´¢ [\*\*Egg.js \*\*](https://link.juejin.cn/?target=https%3A%2F%2Fwww.eggjs.org%2Fzh-CN%2F "https://www.eggjs.org/zh-CN/")å®˜æ–¹æ¨¡æ¿ã€‚ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac67807b00bb4d18b960f3ff17d46756~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

### 2.2 ç«‹å³åˆ›å»ºï¼š

> ç”±äºåœ¨çº¿ IDE åœ¨ç®€å•å°è¯•åæ„Ÿè§‰è¿˜æ˜¯ä¸å¤ªåˆ©äºè°ƒè¯•ï¼Œå°¤å…¶æ˜¯å¯¹ egg.js å’Œå‡½æ•°è®¡ç®— FC éƒ½è¿˜ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ä¼™ä¼´ä¸å»ºè®®ç›´æ¥åœ¨åœ¨çº¿ IDE ä¸­å¼€å‘ã€‚

#### ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6e24fb4c73d459394a7e2d2addcc981~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)2.2.1 éƒ¨ç½²ç±»å‹ï¼š

æˆ‘ä»¬é€‰æ‹©ç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ªä»£ç æ‰˜ç®¡å¹³å°æ¥ã€é€šè¿‡ä»£ç ä»“åº“éƒ¨ç½²ã€‘ ï¼Œã€ä»“åº“ç”¨æˆ·/ç»„ç»‡ã€‘åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™éœ€è¦è·³è½¬åˆ°æ‰˜ç®¡å¹³å°è¿›è¡Œä¸€æ¬¡æˆæƒ~

#### 2.2.2 è§¦å‘æ–¹å¼ï¼š

ã€è§¦å‘æ–¹å¼ã€‘å¯ä»¥é€‰æ‹©å½“ä»£ç æ¨é€è‡³ master åˆ†ä¹‹åæ‹‰å–å¹¶æ„å»ºï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å‘å¸ƒ Release åæ„å»ºï¼Œæˆ‘è®¤ä¸ºé€‰æ‹©é»˜è®¤çš„ä»£ç æ¨é€ master åæ„å»ºæ˜¯ç¬¦åˆå­¦ä¹ é˜¶æ®µçš„~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ee43b1837a349aebb1a2e4fba1be9dc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

#### 2.2.3 æœåŠ¡å&å‡½æ•°åï¼š

ã€æœåŠ¡åã€‘å’Œã€å‡½æ•°åã€‘åœ¨æ¯æ¬¡åˆ›å»ºçš„æ—¶å€™æä¾›çš„é»˜è®¤åç§°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¿…é¡»è¦**é‡æ–°å‘½å**ï¼Œ**åˆ‡è®°è¦é‡æ–°å‘½å**ï¼Œå¦åˆ™ä¼šè¦†ç›–æ‰ä¹‹å‰å·²ç»ä»åœ¨çš„æœåŠ¡å’Œå‡½æ•°ï¼Œé‡ååœ¨åˆ›å»ºæ—¶æœªèƒ½è§¦å‘æ ¡éªŒçš„é—®é¢˜æŠ€æœ¯å·²ç»åœ¨å·¥å•å›å¤ä¼šåšè¯„ä¼°äº†~

#### 2.2.4 ç­‰å¾…åˆ›å»ºï¼š

åˆ›å»ºåº”ç”¨åŒ…æ‹¬äº†åŒæ­¥æ¨¡æ¿ä»£ç åˆ°ä½ æ‰€é€‰çš„æ‰˜ç®¡ä»“åº“ï¼Œåœ¨ Ali å‡½æ•°è®¡ç®— FC å¼€è¾Ÿç©ºé—´æ¥åˆ›å»ºåº”ç”¨ï¼Œå®Œæˆåˆ›å»ºåå¼€å§‹æ‰§è¡Œéƒ¨ç½²å·¥ä½œ~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1c80bcc73864168a83905ec93671d5a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image) éƒ¨ç½²å®Œæˆååœ¨å½“å‰åº”ç”¨çš„è¯¦æƒ…é¡µé¢æˆ–åº”ç”¨åˆ—è¡¨é¡µé¢å¯ä»¥é€šè¿‡æä¾›çš„åŸŸåè®¿é—®Eggjs æä¾›çš„é»˜è®¤é¦–é¡µ~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/134609949f064eb08dded5574e47a1f0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

### 2.3 å¿…è¦çš„é…ç½®ä¿®æ”¹ï¼š

#### 2.3.1 è‡ªå®šä¹‰åŸŸåï¼š

å¦‚æœä½ æœ‰é˜¿é‡Œäº‘çš„åŸŸåçš„è¯å¯ä»¥åœ¨ã€é«˜çº§åŠŸèƒ½ã€‘-ã€åŸŸåç®¡ç†ã€‘-ã€æ·»åŠ è‡ªå®šä¹‰åŸŸåã€‘ï¼Œåœ¨åŸŸåè§£æçš„æ—¶å€™é€šå¸¸è§£æäºŒçº§åŸŸåè€Œä¸æ˜¯ç›´æ¥è§£æåˆ°ä¸»åŸŸåä¸‹ï¼Œæˆ‘çš„ä¸»åŸŸåæ˜¯ [it200.cn](https://link.juejin.cn/?target=http%3A%2F%2Fit200.cn "http://it200.cn")ï¼Œå¾…è§£æçš„äºŒçº§åŸŸåä½¿ç”¨äº† [wx.it200.cn](https://link.juejin.cn/?target=http%3A%2F%2Fwx.it200.cn "http://wx.it200.cn")ã€‚ è·¯ç”±é…ç½®é€‰æ‹©åˆšåˆ›å»ºçš„åº”ç”¨æ—¶å¡«å†™çš„æœåŠ¡åå’Œå‡½æ•°åï¼Œç‰ˆæœ¬ä½¿ç”¨æœ€æ–°çš„LATSETç‰ˆæœ¬~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a189cb8e530544b085f6af0460dbdad6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image) **åŸŸåè§£æ**ç®€è¦è¯´ä¸€ä¸‹ï¼šå½“è¦ä½¿ç”¨ä¸€ä¸ªè‡ªå·±çš„åŸŸåï¼ˆè‡ªå®šä¹‰åŸŸåï¼‰å»ä»£æ›¿å¦ä¸€ä¸ªåŸŸåï¼ˆé»˜è®¤æä¾›åŸŸåï¼‰æ—¶ï¼Œè®°å½•ç±»å‹éœ€è¦é€‰æ‹© **CNAME**ï¼Œ**ä¸»è®°å½•**åªéœ€è¦å¡«å†™äºŒçº§éƒ¨åˆ†ï¼Œ**è§£æçº¿è·¯**ä¸éœ€è¦ä¿®æ”¹ï¼Œ**è®°å½•å€¼**å°±æ˜¯è¢«ä»£ç†çš„åŸŸåï¼Œé…ç½®è§£æåä½ å°±å¯ä»¥ç¨ç­‰ç‰‡åˆ»å»å°è¯•è®¿é—®äº†~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa27f88cbbb245b3ab904c6919200745~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

#### 2.3.2 ç¯å¢ƒå˜é‡é…ç½®åŠå‡½æ•°ä¸­è¯»å–ï¼š

> åœ¨å¯¹æ¥å¾®ä¿¡ SDK æˆæƒçš„æ—¶å€™éœ€è¦ä½¿ç”¨åˆ°å¾®ä¿¡æä¾›çš„å®‰å…¨ç§˜é’¥å’Œå‡­è¯ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨éƒ¨ç½²æœåŠ¡çš„æ—¶å€™å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥é…ç½®ï¼Œè¿™æ ·çš„ä¿¡æ¯æ˜¯ä¸é€‚åˆæ”¾ç½®åˆ°ä»£ç ä¸­çš„~

å¢åŠ ä¸€ä¸ªè·å–ç¯å¢ƒå˜é‡åä¸º **APPID** çš„æ§åˆ¶å™¨å¹¶æ³¨å†Œåˆ°åä¸º `env` çš„è·¯ç”±å¯¹è±¡ä¸­~

```
// æ§åˆ¶å™¨
async getEnv() {
  const { ctx } = this;
  ctx.body = process.env.APPID;
}

// è·¯ç”±é…ç½®
router.get('/env', controller.home.getEnv);

```

æ¨é€ä»£ç å¹¶ç­‰å¾…é‡æ–°éƒ¨ç½²åé…ç½®å¦‚ä¸‹ç¯å¢ƒå˜é‡ï¼Œç¯å¢ƒå˜é‡åœ¨ã€æœåŠ¡åˆ—è¡¨ã€‘-ã€æœåŠ¡ xxx è¯¦æƒ…ã€‘-ã€å‡½æ•°ç®¡ç†ã€‘-ã€å‡½æ•°è¯¦æƒ…ã€‘-ã€**å‡½æ•°é…ç½®**ã€‘ä¸­ï¼Œæ­£å¸¸é€šè¿‡è®¿é—®[è·å– ENV](https://link.juejin.cn/?target=http%3A%2F%2Fwx.it200.cn%2Fenv "http://wx.it200.cn/env")æ¥å£å°†ä¼šåœ¨æµè§ˆå™¨ä¸­è¾“å‡ºäº†é…ç½®çš„ **APPID** å¯¹åº”çš„å€¼~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44d75246d8854a968af137201832b629~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

#### 2.3.3 å‡½æ•°è§¦å‘å™¨æ”¯æŒ POSTï¼š

ä½¿ç”¨è¿‡ Egg.jsæ­å»ºæœåŠ¡çš„ä¼™ä¼´ä¼šçŸ¥é“ Egg.js é»˜è®¤å¼€å¯çš„ [CSRF](https://link.juejin.cn/?target=https%3A%2F%2Fwww.eggjs.org%2Fzh-CN%2Fcore%2Fsecurity%23%25E5%25AE%2589%25E5%2585%25A8%25E5%25A8%2581%25E8%2583%2581-csrf-%25E7%259A%2584%25E9%2598%25B2%25E8%258C%2583 "https://www.eggjs.org/zh-CN/core/security#%E5%AE%89%E5%85%A8%E5%A8%81%E8%83%81-csrf-%E7%9A%84%E9%98%B2%E8%8C%83") å®‰å…¨ç­–ç•¥ï¼Œå½“æˆ‘ä»¬å‘èµ· POST è¯·æ±‚åä¼šè‚¯å¿«åœ¨æ§åˆ¶å°æ”¶åˆ° 403 æ‹’ç»è®¿é—®çš„çŠ¶æ€ç ï¼Œä½†å½“æˆ‘å»å…³é—­ CSRF ç­–ç•¥åä¾ç„¶æ”¶åˆ°äº† 403 çš„çŠ¶æ€ç ï¼Œä¸€åº¦æˆ‘æ€€ç–‘è¿™ä¸ªé…ç½®ä¸å…è®¸ä¿®æ”¹ï¼Œåœ¨å’¨è¯¢ ali æŠ€æœ¯åçŸ¥é“è¦æƒ³ä½¿ç”¨ POST æ–¹å¼æ¥è§¦å‘æ¥å£éœ€è¦åšå•ç‹¬çš„é…ç½®~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f899ec3fa1504bc9bc68125e97a58fe8~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image) ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/45cdc4e0aa984a2c89a4cab74d6aa937~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

## 3. ç§»æ¤WxSDK æˆæƒä»£ç ï¼š
-----------------

> æˆæƒä»£ç æœ¬åœ°ç‰ˆæœ¬ï¼š`git clonne git@github.com:OSpoon/wechat4node.git`

### 3.1 å¿…è¦ä¾èµ–å®‰è£…ï¼š

#### 3.1.1 crypto-jsï¼š

> npm i crypto-js

æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°æä¾›çš„ SHA1 ç®—æ³•æ¥éªŒè¯è…¾è®¯æœåŠ¡å™¨å‘æ¥çš„æ•°æ®ç­¾åå’Œè®¡ç®—ç­¾åæä¾›ç»™è…¾è®¯æœåŠ¡å™¨æ¥éªŒè¯æˆ‘ä»¬çš„æ•°æ®å¯é ï¼Œä»£ç è§ `service` æ–‡ä»¶å¤¹~

#### 3.1.2 egg-corsï¼š

> npm i egg-cors

å®‰è£…åå¼€å¯æ’ä»¶ï¼š

```
// plugin.ts
const plugin: EggPlugin = {
  cors: {
    enable: true,
    package: 'egg-cors',
  },
};

```

å®‰è£…åé…ç½®æ’ä»¶ï¼Œæ”¾å¼€\*\* **[**CORS**](https://link.juejin.cn/?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2016%2F04%2Fcors.html "https://www.ruanyifeng.com/blog/2016/04/cors.html")** \*\*é™åˆ¶ï¼š

```
// config.default.ts
config.cors = {
  origin: '*',
  allowMethods: 'GET, PUT, POST,DELETE, PATCH',
};

```

### 3.2 å…³é—­ CSRF å®‰å…¨ç­–ç•¥ï¼š

CSRF å®‰å…¨ç­–ç•¥åœ¨å‰åç«¯ä¸åˆ†ç¦»çš„åº”ç”¨åœºæ™¯ä½¿ç”¨å¹¿æ³›ï¼Œåœ¨å‰åç«¯åˆ†ç¦»åé€šå¸¸ä½¿ç”¨ JWT æ¥å®ç°æˆæƒè¿‡ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹Ÿä¸é‡‡ç”¨ CSRF ç­–ç•¥ï¼Œæˆ‘ä»¬é€šè¿‡é…ç½®æ¥å…³é—­~

```
// config.default.ts
config.security = {
  csrf: {
    enable: false, // å…³é—­csrf
  },
};

```

### 3.3 ç§»æ¤è·¯ç”±é…ç½®ï¼š

1.  checkOriginï¼šåœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ä¸»åŠ¨å‘èµ·çš„æœåŠ¡éªŒè¯æ—¶ä½¿ç”¨ï¼›
2.  tokenï¼šå…¬ä¼—å·ç›¸å…³ API æˆæƒä¿¡æ¯è·å–æ¥å£ï¼›
3.  ticketï¼šå…¬ä¼—å·ç›¸å…³ API ç¥¨æ®æ•°æ®è·å–æ¥å£ï¼›
4.  signatureï¼šå…¬ä¼—å· JS-SDK åœ¨åˆå§‹åŒ–ä½¿ç”¨çš„æˆæƒä¿¡æ¯è·å–æ¥å£ï¼›

```
router.get('/checkOrigin', controller.home.checkOrigin);
router.get('/token', controller.home.token);
router.get('/ticket', controller.home.ticket);
router.post('/signature', controller.home.signature);

```

### 3.4 ç§»æ¤æ§åˆ¶å™¨ï¼š

åœ¨æ§åˆ¶å™¨ä¸­åªéœ€è¦ä¿ç•™çš„å…¥å‚ã€å‡ºå‚å’Œæ‰§è¡Œé€»è¾‘çš„è°ƒç”¨ä»£ç ï¼Œå…¶ä»–å®ƒçš„å…·ä½“ä¸šåŠ¡é€»è¾‘å‡ `service` å±‚ç¼–å†™ï¼Œå¼‚å¸¸å¤„ç†å’Œç»Ÿä¸€å“åº”æš‚æ—¶ä¸éœ€è¦è€ƒè™‘~

```
async checkOrigin() {
  const { ctx } = this;
  const { signature, timestamp, nonce, echostr } = ctx.query;
  const result = await ctx.service.weChat.checkSignature(
    signature,
    timestamp,
    nonce,
  );
  ctx.body = result ? echostr : '';
}

async token() {
  const { ctx } = this;
  ctx.body = await ctx.service.weChat.getToken();
}

async ticket() {
  const { ctx } = this;
  ctx.body = await ctx.service.weChat.getTicket();
}

async signature() {
  const { ctx } = this;
  const { url } = ctx.request.body;
  ctx.body = await ctx.service.weChat.genSignature(url);
}

```

### 3.5 ç§»æ¤æœåŠ¡å±‚ï¼š

åœ¨ app ç›®å½•ä¸‹æ–°å»º `service/WeChat.js`å¹¶ç§»æ¤å¯¹åº”[ä»£ç ](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FOSpoon%2Fwechat4node%2Fblob%2F92c4d596c23c0b44c06075e83f853e20e9300385%2Fserver%2Fapp%2Fservice%2FWeChat.ts "https://github.com/OSpoon/wechat4node/blob/92c4d596c23c0b44c06075e83f853e20e9300385/server/app/service/WeChat.ts")~

#### 3.5.1 å¸¸é‡ APPID å’Œ APPSECRET æ”¹ä¸ºä½¿ç”¨ç¯å¢ƒå˜é‡è¯»å–ï¼š

1.  `const APPID = process.env.APPID;`
2.  `const APPSECRET = process.env.APPSECRET;`

#### 3.5.1 å¯¹è±¡ç¼“å­˜åº”ç”¨ï¼š

å¾®ä¿¡æä¾›çš„ `access_token` å’Œ `ticket`éƒ½æœ‰é¢‘ç‡é™åˆ¶ï¼Œä¸é€‚åˆæ¯æ¬¡éƒ½ç›´æ¥è°ƒç”¨å¾®ä¿¡æ‰€æä¾›çš„æ¥å£ï¼Œæˆ‘ä»¬åœ¨æ²¡æœ‰ Redis ç­‰è¿™ç§æ•°æ®å­˜å‚¨çš„æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨å¯¹è±¡ç¼“å­˜æ¥å®ç°`access_token`å’Œ`ticket`çš„ç¼“å­˜ï¼Œå®ç°æ¥å£çš„é™é¢‘å¤„ç†~

```
const cache = {
  token: {
    access_token: undefined,
    expires_in: 0,
    last_time: 0,
  },
  ticket: {
    ticket: undefined,
    expires_in: 0,
    last_time: 0,
  },
};

export default class WeChat extends Service {}

```

## 4. éªŒè¯äº‘å‡½æ•°æ‰§è¡Œæƒ…å†µï¼š
--------------

### 4.1 åˆ›å»º Vue é¡¹ç›®ï¼š

1.  æ‰§è¡Œ`yarn create vite` åˆ›å»ºï¼›
2.  æ·»åŠ  js-sdk è„šæœ¬åˆ° index.htmlï¼š

```
<script src="http://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>

```

3.  å®‰è£…axioså®Œæˆæ¥å£æ•°æ®äº¤æ¢ï¼›

### 4.2 ç§»æ¤å‰ç«¯ä»£ç ï¼š

é‡å¤çš„å°±ä¸è¦å†å†™äº†ï¼Œcopy ä¸€ä¸‹~

```
<script setup>
import { ref } from "vue";
import axios from "axios";
const message = ref("");
const status = ref("");
axios
  .post(`http://wx.it200.cn/signature`, {
    url: location.href.split("#")[0],
  })
  .then((res) => {
    const { appId, nonceStr, signature, timestamp } = res.data;
    console.log("[ res ] >", appId, nonceStr, signature, timestamp);
    wx.config({
      debug: true, // å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰ api çš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯ alert å‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ pc ç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡ log æ‰“å‡ºï¼Œä»…åœ¨ pc ç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚
      appId, // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
      timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
      nonceStr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
      signature, // å¿…å¡«ï¼Œç­¾å
      jsApiList: ["updateAppMessageShareData"], // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„ JS æ¥å£åˆ—è¡¨
    });
    wx.error((res) => {
      message.value = res.errMsg;
    });
    wx.ready(() => {
      wx.checkJsApi({
        jsApiList: ["updateAppMessageShareData"], // éœ€è¦æ£€æµ‹çš„ JS æ¥å£åˆ—è¡¨ï¼Œæ‰€æœ‰ JS æ¥å£åˆ—è¡¨è§é™„å½•2,
        success: (res) => {
          wx.updateAppMessageShareData({
            title: "æˆ‘çš„æ˜é‡‘", // åˆ†äº«æ ‡é¢˜
            desc: "æˆ‘åœ¨æ˜é‡‘è¾“å‡ºå‰ç«¯çŸ¥è¯†~", // åˆ†äº«æè¿°
            link: "https://juejin.cn/user/3966693685871694", // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å· JS å®‰å…¨åŸŸåä¸€è‡´
            imgUrl:
              "https://p9-passport.byteacctimg.com/img/user-avatar/71ca4682501063257d8413ff726105a0~300x300.images", // åˆ†äº«å›¾æ ‡
            success: function () {
              status.value = "è®¾ç½®æˆåŠŸ";
            },
          });
        },
      });
    });
  });
</script>

```
```

<template>
  <h3 v-if="message">{{ message }}</h3>
  <h3 v-else>
    ç‚¹å‡»å³ä¸Šè§’=>åˆ†äº«ç»™æœ‹å‹
    <h5>{{ status }}</h5>
  </h3>
</template>

```

### 4.3 é‡æ–°é…ç½®ç¯å¢ƒå˜é‡å’Œè§¦å‘å™¨ï¼š

å½“æˆ‘ä»¬æŠŠä»£ç æ¯æ¬¡ push åˆ°è¿œç¨‹ç­‰å¾…éƒ¨ç½²æˆåŠŸåï¼Œä¸Šä¸€æ¬¡é…ç½®çš„ç¯å¢ƒå˜é‡å’Œè§¦å‘å™¨å°±ä¸¢å¤±äº†ï¼Œé—®é¢˜æ˜¯ç”±äºä»£ç åº“é‡Œé¢çš„ `s.yaml` é…ç½®æ–‡ä»¶è¦†ç›–å¯¼è‡´çš„ï¼Œè¿™ä¸ªæ–‡ä»¶å°±ç•™ç»™æœ‰å¿ƒçš„å°ä¼™ä¼´ç ”ç©¶ç ”ç©¶æ€ä¹ˆæ ·~

### 4.4 éªŒè¯äº‘å‡½æ•°æ‰§è¡Œï¼š

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ­£å¸¸æ‰“å¼€å‰ç«¯é¡¹ç›®é¡µé¢åï¼Œä¼šå…ˆç›´æ¥ **token è·å–**ï¼Œ**ç¥¨æ®è·å–**ï¼Œ**åˆæˆéªŒç­¾**ä¸‰æ­¥ï¼Œåœ¨å‰ç«¯æ‹¿åˆ°éªŒç­¾æ•°æ®åæ­£å¸¸åˆå§‹åŒ– wx.config ï¼Œå¹¶æç¤ºæˆæƒæˆåŠŸ~ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2964e52e7b294111afeec0c12dd2805f~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

## 5. æ€»ç»“
------

å¾®ä¿¡ SDK æˆæƒæœåŠ¡çš„ä¸Šäº‘å°±ç®—æ˜¯æš‚æ—¶æå®šäº†ï¼Œå‰å‰ååæŠ˜è…¾çš„æ—¶é—´ä¸çŸ­ï¼Œå°è¯•äº†å¤šæ¬¡ï¼Œè¿™ä¸€æ¬¡æ˜¯æœ€é¡ºåˆ©çš„ï¼Œäº‘å‡½æ•°åœ¨æ²¡æœ‰æœåŠ¡å™¨çš„æƒ…å†µä¸‹å¯¹äºå‰ç«¯å¼€å‘è€…åº”è¯¥è¿˜æ˜¯å¾ˆå‹å¥½çš„ï¼ˆç›¸æ¯”äºæœåŠ¡å™¨æ“ä½œæ¥è¯´ï¼‰ï¼Œè¦ä¸è¦ä¸€èµ·æ¥è¸©å‘å‘¢ï¼Ÿåé¢è¿˜ä¼šå¯¹æ¥ä¸Šä¸€ç¯‡çš„ã€æ¶ˆæ¯é€šçŸ¥ã€‘æ¥å®æ‰“å®çš„å°†è¿™ä¸ªæœåŠ¡åº”ç”¨èµ·æ¥~

* * *

**å¦‚æœçœ‹å®Œè§‰å¾—æœ‰æ”¶è·ï¼Œæ¬¢è¿ç‚¹èµã€è¯„è®ºã€åˆ†äº«æ”¯æŒä¸€ä¸‹ã€‚ä½ çš„æ”¯æŒå’Œè‚¯å®šï¼Œæ˜¯æˆ‘åšæŒå†™ä½œçš„åŠ¨åŠ›~** æœ€åå¯ä»¥å…³æ³¨æˆ‘@å°é‘«åŒå­¦ã€‚æ¬¢è¿[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")[fe-xiaoxin](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")äº¤æµï¼Œå…±åŒè¿›æ­¥ï¼ˆè¿˜å¯ä»¥å¸®ä½ **fix**ğŸ›ï¼‰~