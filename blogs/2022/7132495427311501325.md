---
title: å¼€å‘ Babel æ’ä»¶å¯ä»¥è¯•è¯•è¿™ä¸ª CLI å·¥å…·
date: '2022-08-16 23:25'
sidebar: 'auto'
categories:
 - Compiler
tags:
 - Babel
---

:::tip
åœ¨ä¸Šä¸€ç¯‡[ã€å…¥é—¨ã€‘ä½ è¿Babeléƒ½ä¸ä¼šé…ï¼Ÿé‚£æ’ä»¶ä¸æˆä¹±è£…äº†](https://juejin.cn/post/7129535563639554085 "https://juejin.cn/post/7129535563639554085")ä¸­è®²è¿°äº† babel çš„ä½¿ç”¨å’Œæ’ä»¶/é¢„è®¾çš„é…ç½®ï¼Œè¿™ä¸€ç¯‡æˆ‘æƒ³å†™å†™ Babel æ’ä»¶å¼€å‘çš„å­¦ä¹ è¿‡ç¨‹ï¼Œåœ¨ç¿»æ‰¾èµ„æ–™çš„æ—¶å€™å‘ç°çš„è¿™ä¸ªå¯èƒ½å·²ç»è¿‡æ—¶çš„ CLI å·¥å…·ï¼Œ é‚£ä¹ˆå°±è·Ÿéšæˆ‘æ¥å¿«é€Ÿæå®šç¬¬ä¸€ä¸ª Babel æ’ä»¶å§~
:::

<!-- more -->

## 1. å‰è¨€
------

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[å°é‘«åŒå­¦](https://juejin.cn/user/3966693685871694 "https://juejin.cn/user/3966693685871694")ã€‚ä¸€ä½ä»äº‹è¿‡**Androidå¼€å‘**ã€**æ··åˆå¼€å‘**ï¼Œç°åœ¨é•¿æœŸä»äº‹**å‰ç«¯å¼€å‘**çš„ç¼–ç¨‹çˆ±å¥½è€…ï¼Œ**æˆ‘è§‰å¾—åœ¨ç¼–ç¨‹ä¹‹è·¯ä¸Šæœ€é‡è¦çš„æ˜¯çŸ¥è¯†çš„åˆ†äº«ï¼Œæ‰€è°“ä¸‰äººè¡Œå¿…æœ‰æˆ‘å¸ˆ**ã€‚æ‰€ä»¥æˆ‘å¼€å§‹åœ¨ç¤¾åŒºæŒç»­è¾“å‡ºæˆ‘æ‰€äº†è§£åˆ°ã€å­¦ä¹ åˆ°ã€å·¥ä½œä¸­é‡åˆ°çš„å„ç§ç¼–ç¨‹çŸ¥è¯†ï¼Œæ¬¢è¿æœ‰æƒ³æ³•ã€æœ‰åŒæ„Ÿçš„ä¼™ä¼´åŠ æˆ‘[fe-xiaoxin](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")å¾®ä¿¡äº¤æµ~

åœ¨ä¸Šä¸€ç¯‡[ã€å…¥é—¨ã€‘ä½ è¿Babeléƒ½ä¸ä¼šé…ï¼Ÿé‚£æ’ä»¶ä¸æˆä¹±è£…äº†](https://juejin.cn/post/7129535563639554085 "https://juejin.cn/post/7129535563639554085")ä¸­è®²è¿°äº† babel çš„ä½¿ç”¨å’Œæ’ä»¶/é¢„è®¾çš„é…ç½®ï¼Œè¿™ä¸€ç¯‡æˆ‘æƒ³å†™å†™ Babel æ’ä»¶å¼€å‘çš„å­¦ä¹ è¿‡ç¨‹ï¼Œåœ¨ç¿»æ‰¾èµ„æ–™çš„æ—¶å€™å‘ç°çš„è¿™ä¸ªå¯èƒ½å·²ç»è¿‡æ—¶çš„ CLI å·¥å…·ï¼Œ é‚£ä¹ˆå°±è·Ÿéšæˆ‘æ¥å¿«é€Ÿæå®šç¬¬ä¸€ä¸ª Babel æ’ä»¶å§~

## 2. ç¯å¢ƒ/èµ„æ–™å‡†å¤‡ï¼Ÿ
------------

### 2.1 å¿…å¤‡å·¥å…·ï¼š

1.  [**babel-plugin-2**](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FOSpoon%2Fgenerator-babel-plugin "https://github.com/OSpoon/generator-babel-plugin")ï¼šæ’ä»¶å¼€å‘å¥—ä»¶ï¼ˆforkè‡ª[generator-babel-plugin](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbabel%2Fgenerator-babel-plugin "https://github.com/babel/generator-babel-plugin")ï¼‰ï¼›
2.  [**AST Explorer**](https://link.juejin.cn/?target=https%3A%2F%2Fastexplorer.net%2F "https://astexplorer.net/")ï¼šæŠ½è±¡è¯­æ³•æ ‘åœ¨çº¿åˆ†æï¼›

### 2.2 å­¦ä¹ èµ„æ–™ï¼š

1.  [babeljs](https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2F "https://babeljs.io/")ï¼›
2.  [plugin-handbookä¸­æ–‡ç‰ˆ](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fjamiebuilds%2Fbabel-handbook%2Fblob%2Fmaster%2Ftranslations%2Fzh-Hans%2Fplugin-handbook.md "https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md")ï¼›
3.  [Babel æ’ä»¶é€šå…³ç§˜ç±](https://juejin.cn/book/6946117847848321055?suid=3966693685871694&source=ios "https://juejin.cn/book/6946117847848321055?suid=3966693685871694&source=ios")ï¼›

## 3. ç¬¬ä¸€ä¸ª Babel æ’ä»¶ï¼š
-----------------

**å¯¹ä»£ç å—ä¸­ console åœ¨æ‰§è¡Œæ—¶å¯ä»¥è¾“å‡ºæ‰€åœ¨çš„ä»£ç è¡Œæ•°**ï¼Œæˆ‘ä»¬çš„ä¾‹å­ä¹Ÿæ˜¯ COPY è‡ª Babel æ’ä»¶é€šè¿‡ç§˜ç±çš„ç¬¬ä¸€ä¸ªç”¨ä¾‹ï¼Œä¹Ÿæ¨èè¯¦ç»†å»å­¦ä¹ ä¸€ä¸‹~

```
1. npm i -g yo generator-babel-plugin-x
2. mkdir babel-plugin-clg-insert-line && cd babel-plugin-clg-insert-line
3. yo babel-plugin-x
4. è¡¥å……æ’ä»¶ä¿¡æ¯ï¼š
    ? Plugin Name clg-insert-line
    ? Description 
    ? GitHub username or organization 
    ? Author's Name 
    ? Author's Email 
    ? Key your keywords (comma to split)

```

æ‰§è¡Œå®Œä¸Šé¢çš„æ­¥éª¤åå°±ç”Ÿæˆäº†ç¬¬ä¸€ä¸ªæ‹¥æœ‰æ ‡å‡†è‡ªè¿°æ–‡æ¡£ã€æµ‹è¯•ç”¨ä¾‹çš„å®Œæ•´æ’ä»¶é¡¹ç›®~

### 3.1 è¡¥å……è‡ªè¿°æ–‡æ¡£ï¼š

CLI ç”Ÿæˆçš„è‡ªè¿°æ–‡æ¡£åŒ…æ‹¬èŒƒä¾‹ã€å®‰è£…ã€ä½¿ç”¨çš„æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦è¡¥å……éœ€è¦å¤„ç†çš„ä»£ç å’Œå¤„ç†å®Œæˆåçš„ç»“æœä»£ç ~

```
console.log(1);

function func() {
	console.info(2);
}

export default class Clazz {
	say() {
		console.debug(3);
	}
	render() {
		return <div>{console.error(4)}</div>;
	}
}

```
```
console.log("line 1", 1);

function func() {
	console.info("line 4", 2);
}

export default class Clazz {
	say() {
		console.debug("line 9", 3);
	}
	render() {
		return <div>{console.error("line 12", 4)}</div>;
	}
}

```

### 3.2 å®Œå–„æµ‹è¯•ç”¨ä¾‹ï¼š

åœ¨æ’ä»¶é¡¹ç›®çš„`__tests__/fixtures/example`ç›®å½•ä¸‹ç”Ÿæˆäº†ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å®Œå–„`actual.js`å’Œ`expected.js`ï¼Œå…¶å®ä¹Ÿæ˜¯è‡ªè¿°æ–‡æ¡£ä¸­è¡¥å……çš„ä¸¤å—ä»£ç ï¼Œæˆ‘ä»¬ç¼–å†™åçš„æ’ä»¶åœ¨å¯¹`actual.js`çš„å†…å®¹å¤„ç†åçš„ç»“æœåº”è¯¥å’Œ`expected.js`çš„å†…å®¹ä¸€è‡´~

### 3.3 æŸ¥çœ‹ AST åŠåˆ†æï¼š

[Astexplorer](https://link.juejin.cn/?target=https%3A%2F%2Fastexplorer.net%2F%23%2Fgist%2F763781d76b0d3f8486cdda748cd7dc39%2F232fda799045f748ecebbb5553589f722d15265b "https://astexplorer.net/#/gist/763781d76b0d3f8486cdda748cd7dc39/232fda799045f748ecebbb5553589f722d15265b")ï¼Œæˆ‘ä»¬åœ¨é€‰ä¸­å…¶ä¸­ä¸€æ¡`console`è¯­å¥åå³ä¾§çª—å£é«˜äº®äº†ä¸€ç‰‡ **ExpressionStatement** åŒºåŸŸï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯è¢«åŒ…è£¹åœ¨é‡Œé¢çš„è°ƒç”¨è¡¨è¾¾å¼`CallExpression`ï¼Œè¿™`CallExpression`é‡Œé¢åŒ…å«è¢«è°ƒç”¨è¡¨è¾¾å¼ï¼ˆ`callee`ï¼‰ è°ƒç”¨å‚æ•°ï¼ˆ`arguments`ï¼‰ã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a306784425a4200b6f9cbdbf09762af~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?)

1.  é€šè¿‡`callee`ä¸­åŒ…å«çš„ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦å¤„ç†çš„ä½ç½®ï¼›
2.  è¯»å–`loc/start/line` å±æ€§å¯ä»¥å¾—åˆ°å½“å‰è°ƒç”¨è¡¨è¾¾å¼æ‰€åœ¨è¡Œå·ï¼›
3.  é€šè¿‡å‘`arguments`æ•°ç»„çš„ç¬¬ä¸€ä½æ’å…¥è¡Œå·æ¥å®Œæˆç›®æ ‡ï¼›

### 3.4 ç¼–å†™æ’ä»¶éƒ¨åˆ†ï¼š

#### 3.4.1 å·²æä¾›çš„æ¨¡æ¿ï¼š

åœ¨è¿™ä¸ªæ’ä»¶æ¨¡æ¿ä¸­æˆ‘ä»¬å°†éœ€è¦è¢«å…³æ³¨çš„è¡¨è¾¾å¼æ·»åŠ åˆ°**visitor**å¯¹è±¡ä¸­ï¼Œå½“éå†åˆ° AST ä¸ºæˆ‘ä»¬å…³æ³¨çš„è¡¨è¾¾å¼æ—¶å°†ä¼šè¢«æ‰§è¡Œï¼Œåœ¨ `t`ä¸­è¿˜åŒ…å«äº†å¾ˆå¤šå®ç”¨çš„å·¥å…·å¾…æˆ‘ä»¬å‘æ˜~

```
export default function({types: t }) {
  return {
    visitor: {
      
    }
  };
}

```

#### 3.4.2 åˆ¤æ–­æ˜¯å¦è¾¾åˆ°å¤„ç†çš„è¡¨è¾¾å¼ï¼š

1.  åˆ¤æ–­`callee`çš„ç±»å‹æ˜¯å¦ç¬¦åˆ`MemberExpression`ï¼›
2.  åˆ¤æ–­`path.node.callee.object.name`æ˜¯å¦ä¸º`console`ï¼›
3.  åˆ¤æ–­`path.node.callee.property.name`æ˜¯å¦åŒ…å«`'log', 'info', 'error', 'debug'`ï¼›

```
CallExpression(path) {
  if (t.isMemberExpression(path.node.callee)
      && path.node.callee.object.name === 'console'
      && ['log', 'info', 'error', 'debug'].includes(path.node.callee.property.name)
     ) {
    ã€‚ã€‚ã€‚
  }
}

```

#### 3.4.3 æ’å…¥ä»£ç è¡Œå·ï¼š

ä½¿ç”¨``t.stringLiteral(`line ${line}`)``æ¥å®ç° AST å¯¹è±¡æ’å…¥~

```
const { line } = path.node.loc.start;
path.node.arguments.unshift(t.stringLiteral(`line ${line}`))

```

### 3.5 å®Œå–„ä¸€å¤„é…ç½®å’Œä¸€å¤„æ›´æ”¹ï¼š

#### 3.5.1 å®Œå–„é…ç½®ï¼š

åœ¨å¾…å¤„ç†çš„æºç ä¸­æ¶‰åŠåˆ°äº† jsx è¯­æ³•çš„å¤„ç†ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šé…ç½®æ‰èƒ½æ”¯æŒï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨æ’ä»¶çš„æ—¶å€™ä¹Ÿå°±æ˜¯æµ‹è¯•ç”¨ä¾‹çš„ babel é…ç½®ä¸­å¤„ç†å°±å¯ä»¥~

```
{
  "plugins": [
    ["../../../src"]
  ],
  // è¡¥å……æ”¯æŒ jsx
  "parserOpts": {
    "plugins": [
      "jsx"
    ]
  }
}

```

#### 3.5.2 å®Œå–„æ›´æ”¹ï¼š

åœ¨`transformFileSync`æ‰§è¡Œåä¼šæœ‰ä¸€äº›ä»£ç é£æ ¼çš„å·®å¼‚ä¼šå½±å“åˆ°æµ‹è¯•ç”¨ä¾‹çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥**replace**æ‰è¿™äº›ç©ºç™½å­—ç¬¦~

```
expect(actual.trim().replace(/\s/g,"")).toEqual(expected.trim().replace(/\s/g,""));

```

### 3.6 æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c6bb74b301e4c4886cd7e7082c5f7d2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image?)

## 4. å‡çº§ä¼˜åŒ–æ’ä»¶ï¼š
-----------

### 4.1 ä½¿ç”¨@babel/generatoræ¥å°† AST è½¬ä¸º Codeï¼š

```
const generate = require("@babel/generator").default;

export default function ({ types: t }) {
  return {
    visitor: {
      CallExpression(path) {
        const calleeName = generate(path.node.callee).code;
        consolg.log(calleeName);
      }
    }
  };
}

```

### 4.2 éå†targetCalleeNameæ¥ä¼˜åŒ–åˆ¤æ–­é€»è¾‘ï¼š

```
const generate = require("@babel/generator").default;
const targetCalleeName = ['log', 'info', 'error', 'debug'].map(item => `console.${item}`);

export default function ({ types: t }) {
  return {
    visitor: {
      CallExpression(path) {
        const calleeName = generate(path.node.callee).code;
        if (targetCalleeName.includes(calleeName)) {
            const { line } = path.node.loc.start;
            path.node.arguments.unshift(t.stringLiteral(`line ${line}`))
        }
      }
    }
  };
}

```

## 5. å‡çº§babel-plugin-xï¼š
---------------------

ç›®å‰æœ€è¿‘çš„Babelæ’ä»¶ç‰ˆæœ¬ï¼ˆv7+ï¼‰éƒ½é‡‡ç”¨Tsç¼–å†™ï¼Œå¹¶ä¸”é£æ ¼ç•¥æœ‰ä¸åŒï¼Œåœ¨Tsä¸­ä½¿ç”¨typesç›¸å…³çš„APIä¹Ÿæ›´åŠ å®¹æ˜“ä¸Šæ‰‹ï¼Œæ‰€ä»¥æ›´æ–°åçš„Cliå°†æ”¯æŒè¿™ä¸€é£æ ¼çš„ç¼–å†™~

## 6. æ€»ç»“
------

é€šè¿‡ä½¿ç”¨ `yo babel-plugin-x` ç”Ÿæˆçš„æ’ä»¶æ¨¡ç‰ˆæ¥å¿«é€Ÿä¸Šæ‰‹äº†ç¬¬ä¸€ä¸ª babelæ’ä»¶ï¼Œå½“ä½ æ„Ÿå—åˆ°äº† babel çš„ä½œç”¨åå†å»äº†è§£æ¯ä¸ªæ¨¡å—çš„ä½œç”¨ï¼Œå†å»æ‹†è§£æ¯ä¸€å—çš„åŠŸèƒ½ä¹Ÿå¯èƒ½ä¼šæ›´å¥½~

`babel-plugin` æº `Cli` æ’ä»¶å·²ç»å¤šå¹´ä¸ç»´æŠ¤äº†ï¼Œæœ‰ä¸ª BUG çš„ PR ä¸€ç›´æ²¡æœ‰åˆå¹¶å¯¼è‡´æ²¡æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘æ¨äº†ä¸€ä¸ª `babel-plugin-x`æ¥ä½¿ç”¨~

* * *

**å¦‚æœçœ‹å®Œè§‰å¾—æœ‰æ”¶è·ï¼Œæ¬¢è¿ç‚¹èµã€è¯„è®ºã€åˆ†äº«æ”¯æŒä¸€ä¸‹ã€‚ä½ çš„æ”¯æŒå’Œè‚¯å®šï¼Œæ˜¯æˆ‘åšæŒå†™ä½œçš„åŠ¨åŠ›~**

æœ€åå¯ä»¥å…³æ³¨æˆ‘@å°é‘«åŒå­¦ã€‚æ¬¢è¿[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")[fe-xiaoxin](https://juejin.cn/pin/7126196941574111262 "https://juejin.cn/pin/7126196941574111262")äº¤æµï¼Œå…±åŒè¿›æ­¥ï¼ˆè¿˜å¯ä»¥å¸®ä½ **fix**ğŸ›ï¼‰~