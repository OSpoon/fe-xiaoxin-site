---
title: åˆ©ç”¨Babelè‡ªåŠ¨ç”Ÿæˆâ€œAttributeâ€æ–‡æ¡£
date: '2022-10-21 21:13'
sidebar: 'auto'
categories:
 - Babel
tags:
 - Babel
---

:::tip
åˆ©ç”¨**Babel**è‡ªåŠ¨è§£ææºç å±æ€§ä¸Šçš„æ³¨é‡Šç”Ÿæˆå¯¹åº”Markdownæ–‡æ¡£ï¼Œè¿™ä¸ªåœºæ™¯çš„åº”ç”¨ä¸»è¦åŒ…æ‹¬åœ¨ç»„ä»¶åº“æ–‡æ¡£å¯¹ç»„ä»¶å±æ€§çš„ä»‹ç»ä¸­ï¼Œè¿™ä¸€ç¯‡å°±é€šè¿‡ç¼–å†™ä¸€ä¸ªBabelæ’ä»¶æ¥å®ç°è¿™ä¸ªåŠŸèƒ½~
:::

<!-- more -->

## 1. å‰è¨€
------

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[å°é‘«åŒå­¦](https://it200.cn/ "https://it200.cn/")ã€‚ä¸€ä½ä»äº‹è¿‡**Androidå¼€å‘**ã€**æ··åˆå¼€å‘**ï¼Œç°åœ¨é•¿æœŸä»äº‹**å‰ç«¯å¼€å‘**çš„ç¼–ç¨‹çˆ±å¥½è€…ï¼Œ**æˆ‘è§‰å¾—åœ¨ç¼–ç¨‹ä¹‹è·¯ä¸Šæœ€é‡è¦çš„æ˜¯çŸ¥è¯†çš„åˆ†äº«ï¼Œæ‰€è°“ä¸‰äººè¡Œå¿…æœ‰æˆ‘å¸ˆ**ã€‚æ‰€ä»¥æˆ‘å¼€å§‹åœ¨ç¤¾åŒºæŒç»­è¾“å‡ºæˆ‘æ‰€äº†è§£åˆ°ã€å­¦ä¹ åˆ°ã€å·¥ä½œä¸­é‡åˆ°çš„å„ç§ç¼–ç¨‹çŸ¥è¯†ï¼Œæ¬¢è¿æœ‰æƒ³æ³•ã€æœ‰åŒæ„Ÿçš„ä¼™ä¼´åŠ æˆ‘[fe-xiaoxin](https://it200.cn/ "https://it200.cn/")å¾®ä¿¡äº¤æµ~

åˆ©ç”¨**Babel**è‡ªåŠ¨è§£ææºç å±æ€§ä¸Šçš„æ³¨é‡Šç”Ÿæˆå¯¹åº”Markdownæ–‡æ¡£ï¼Œè¿™ä¸ªåœºæ™¯çš„åº”ç”¨ä¸»è¦åŒ…æ‹¬åœ¨ç»„ä»¶åº“æ–‡æ¡£å¯¹ç»„ä»¶å±æ€§çš„ä»‹ç»ä¸­ï¼Œè¿™ä¸€ç¯‡å°±é€šè¿‡ç¼–å†™ä¸€ä¸ªBabelæ’ä»¶æ¥å®ç°è¿™ä¸ªåŠŸèƒ½~

## 2. å¼€å‘è‡ªåŠ¨ç”Ÿæˆå±æ€§æ–‡æ¡£æ’ä»¶
### 2.1 ç”ŸæˆBabelæ’ä»¶æ¨¡æ¿ï¼š

- **2.1.1 åˆ›å»º**`babel-plugin-auto-attr-doc`æ–‡ä»¶å¤¹ï¼›
- **2.1.2 å®‰è£…**`npm i -g yo generator-babel-plugin-x`ï¼›
- **2.1.3 åœ¨æ–°å»ºç›®å½•ä¸‹æ‰§è¡Œ** `yo babel-plugin-x:v7-ts`ï¼›

ç”Ÿæˆçš„æ’ä»¶æ¨¡æ¿å¦‚ä¸‹ï¼š
```typescript
babel-plugin-auto-attr-doc  
â”œâ”€ lib                      
â”‚  â””â”€ index.js              
â”œâ”€ src                      
â”‚  â””â”€ index.ts              
â”œâ”€ __tests__                
â”‚  â”œâ”€ fixtures              
â”‚  â”‚  â””â”€ example            
â”‚  â”‚     â”œâ”€ actual.ts       
â”‚  â”‚     â””â”€ expected.ts     
â”‚  â””â”€ index.js              
â”œâ”€ package-lock.json        
â”œâ”€ package.json             
â”œâ”€ README.md                
â””â”€ tsconfig.json            
```
### 2.2 è½¬æ¢æ€è·¯è¯¦è§£ï¼š
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1666190226912-a18a46bc-761a-4d78-974f-bf52e14b9de3.png#clientId=u8f9d2eb6-0aac-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=288&id=ub0a09f64&margin=%5Bobject%20Object%5D&name=image.png&originHeight=288&originWidth=859&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34237&status=done&style=stroke&taskId=ue89ade46-40b5-4656-b068-ec1dc98bb0f&title=&width=859)

- **2.2.1 è½¬æ¢è¿‡ç¨‹ï¼š**åˆ©ç”¨**Babel**å°†**Typescript**è„šæœ¬è§£æä¸º**AST**ï¼Œé€šè¿‡å¯¹**AST**ç»“æ„åˆ†ææŠ½ç¦»å¯¹åº”çš„æ³¨é‡Šéƒ¨åˆ†ï¼Œå†æ‹¼æ¥**Markdown**è¡¨æ ¼é£æ ¼çš„è¯­æ³•ï¼›
- **2.2.2 æºç è¦æ±‚ï¼š**æˆ‘ä»¬åº”è¯¥å°†ç»„ä»¶æ¶‰åŠåˆ°å¯¹å¤–æä¾›çš„å±æ€§ç»Ÿä¸€åˆ°å¯¹åº”çš„`types.ts`æ–‡ä»¶ç®¡ç†ï¼Œåˆ†åˆ«å¯¼å‡ºå¯¹åº”çš„`type`å­—æ®µï¼›
- **2.2.3 æ³¨é‡Šè¦æ±‚ï¼š**åˆ†åˆ«å®šä¹‰å­—æ®µæè¿°ã€ç±»å‹ã€å¯é€‰é¡¹ã€é»˜è®¤å€¼4é¡¹ï¼Œç”±äºè§£æå™¨å…³é”®è¯å†²çªåŸå› ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…ï¼›
```typescript
/**
  * @cDescribe ç±»å‹
  * @cType string
  * @cOptions 
  * @cDefault 
  */
 export type IType = "primary" | "success" | "warning" | "danger" | "info";
 
 /**
  * @cDescribe å›¾æ ‡ç»„ä»¶
  * @cType string
  * @cOptions 
  * @cDefault 
  */
 export type IIcon = string;
 
 /**
  * @cDescribe æ˜¯å¦ä¸ºæœ´ç´ æŒ‰é’®
  * @cType boolean
  * @cOptions 
  * @cDefault false
  */
 export type IPlain = boolean;
```

- **2.2.4 Markdownè¡¨æ ¼ï¼š**å±•ç¤ºç»„ä»¶çš„å±æ€§ã€æè¿°ã€ç±»å‹ã€å¯é€‰å€¼å’Œé»˜è®¤å€¼è¿™å‡ é¡¹ï¼›

![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1666188593960-b2ca3589-8013-4445-a43b-0db94576f1fc.png#clientId=u8f9d2eb6-0aac-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=213&id=u18c78fc2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=213&originWidth=551&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9607&status=done&style=stroke&taskId=ua596c5cd-a6bb-4749-9ab7-7fb70d56683&title=&width=551)
### 2.3 å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼š

1. å‡†å¤‡æ’ä»¶å¾…è§£ææºç æ–‡ä»¶`source-code.ts`ï¼›
2. å‡†å¤‡å®é™…ç”ŸæˆMDååº”è¯¥æ˜¾ç¤ºçš„å†…å®¹æ–‡ä»¶`actual.md`ï¼›
```typescript
| å±æ€§å | è¯´æ˜ | ç±»å‹ | å¯é€‰å€¼	| é»˜è®¤å€¼ |
| ------ | ---- | ---- | ----- | ----- |
| type | ç±»å‹ | string |  |  |
| icon | å›¾æ ‡ç»„ä»¶ | string |  |  |
| plain | æ˜¯å¦ä¸ºæœ´ç´ æŒ‰é’® | boolean |  | false |

```

3. è°ƒæ•´å•å…ƒæµ‹è¯•æ–‡ä»¶è¯»å–ï¼š
```typescript
it(`should ${caseName.split("-").join(" ")}`, () => {
  const actualPath = path.join(fixtureDir, "source-code.ts");

  // å¯¹æºç è¿›è¡ŒåŠ è½½è§£æ
  transformFileSync(actualPath);

  // è¯»å–æˆ‘ä»¬å‡†å¤‡å¥½çš„mdæ–‡ä»¶
  const actual = fs
    .readFileSync(path.join(fixtureDir, "actual.md"))
    .toString();

  // è¯»å–æ’ä»¶è§£æç”Ÿæˆçš„mdæ–‡ä»¶
  const expected = fs
    .readFileSync(path.join(fixtureDir, "api-doc.md"))
    .toString();

  // diff
  const diff = diffChars(actual, expected);
  diff.length > 1 && _print(diff);
  expect(diff.length).toBe(1);
});
```
### 2.4 ASTåˆ†æè¯¦è§£ï¼š

- é€šè¿‡åœ¨[AST explorer](https://astexplorer.net/)çš„æºç åˆ†æï¼Œæˆ‘ä»¬åœ¨Babelä¸­å¯ä»¥é€šè¿‡éå†`ExportNamedDeclaration`ï¼ˆå‘½åå¯¼å‡ºå£°æ˜ï¼‰ï¼›
- åœ¨`leadingComments`æ•°ç»„ä¸­å¯ä»¥å–å‡º**æ‰€æœ‰æ³¨é‡Š**æ–‡æœ¬çš„é›†åˆï¼Œåœ¨**Babel**å¤„ç†æ—¶æˆ‘ä»¬éœ€è¦ä¾æ¬¡å¤„ç†**æ¯ä¸€å—æ³¨é‡Š**åå¢åŠ æ ‡è®°æ¥é¿å…é‡å¤å¤„ç†ï¼›
- åœ¨`(path.node.declaration as t.TypeAlias).id.name`ä¸­å–å±æ€§åç§°ï¼›

å°†æ³¨é‡Šæ–‡æœ¬é€šè¿‡**doctrine**æ¨¡å—è§£æä¸ºå¯¹è±¡åå’Œå±æ€§ååˆå¹¶å¯¹è½¬æ¢Markdownæ‰€éœ€è¦çš„æ‰€æœ‰æ•°æ®~
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1666190835250-9b73e210-cea7-4237-b517-4a9e19b170f7.png#clientId=u8f9d2eb6-0aac-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=891&id=ud26e86a1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=891&originWidth=1892&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37873&status=done&style=stroke&taskId=u053c94e6-ac4b-453f-a52d-f9e17089b05&title=&width=1892)
### 2.5 æ’ä»¶å¼€å‘è¿‡ç¨‹ï¼š
#### 2.5.1 å®šä¹‰Commentã€ApiTableç±»å‹å¯¹è±¡ï¼š
```typescript
type Comment =
  | {
      describe: string;
      type: any;
      options?: any;
      default?: any;
    }
  | undefined;
```
```typescript
type ApiTable = {
  attributeName: any;
  attributeDescribe: any;
  attributeType: any;
  attributeOptions: any;
  attributeDefault: any;
};
```
#### 2.5.2 æ’ä»¶ä¸»é€»è¾‘åˆ†æï¼š

1. **pre**ï¼šåˆå§‹åŒ–å­˜æ”¾apidocå®¹å™¨ï¼Œé¿å…åœ¨å­˜æ”¾æ—¶æ‰¾ä¸åˆ°å®¹å™¨ï¼›
2. **visitor**ï¼šè§£ææºç å¹¶è·å–ç»„ç»‡MDå†…å®¹æ•°æ®æš‚å­˜åˆ°apidocä¸­ï¼›
3. **post**ï¼šå–å‡ºæ‰€æœ‰çš„apidocå†…å®¹è§£æå¹¶è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼›
```typescript
export default declare(
  (api: BabelAPI, options: Record<string, any>, dirname: string) => {
    api.assertVersion(7);

    return {
      name: "auto-attr-doc",
      pre(this: PluginPass, file: BabelFile) {
        this.set("api-doc", []);
      },
      visitor: {
        ExportNamedDeclaration(
          path: NodePath<t.ExportNamedDeclaration>,
          state: PluginPass
        ) {
          const apidoc = state.get("api-doc");
          // å¤„ç† path.node.leadingComments ä¸­æœªå¤„ç†çš„æ•°æ®åå¡åˆ°apidocä¸­
          state.set("api-doc", apidoc);
        },
      },
      post(this: PluginPass, file: BabelFile) {
        const apidoc = this.get("api-doc");
        const output = generateMD(apidoc);
        const root = path.parse(file.opts.filename || "./").dir;
        fs.writeFileSync(path.join(root, "api-doc.md"), output, {
          encoding: "utf-8",
        });
      },
    } as PluginObj<PluginPass>;
  }
);
```
#### 2.5.3 ä¸»é€»è¾‘å®ç°ï¼š

1. `leadingComments`æ•°ç»„ä¼šåœ¨ä¾æ¬¡è®¿é—®`ExportNamedDeclaration`æ—¶ä¸åœå¢åŠ ï¼Œæˆ‘ä»¬åœ¨å¤„ç†æ‰å½“å‰ç´¢å¼•çš„å¯¹è±¡åå¢åŠ ä¸€ä¸ªå¤„ç†è¿‡çš„æ ‡è®°`skip`ï¼Œä¸‹æ¬¡å¾ªç¯ç›´æ¥è·³è¿‡ï¼›
2. é€šè¿‡`parseComment`å‡½æ•°è§£æåçš„å¯¹è±¡å¯ä»¥é€šè¿‡`tags`æ•°ç»„è·å–åˆ°æ‰€æœ‰çš„æ³¨é‡Šé¡¹ç›®ï¼Œé€šè¿‡å¯¹åº”çš„`title`å¾—åˆ°å¯¹åº”`description`å†…å®¹ï¼›
3. åœ¨å¾€**apidoc**å­˜æ”¾æ•°æ®æ—¶éœ€è¦å¤„ç†å±æ€§åç§°ç¬¦åˆä¸€å®šçš„è§„åˆ™ï¼Œå¹¶å°†`apidoc`å¯¹è±¡å­˜æ”¾åˆ°åŸå®¹å™¨ä¸­ï¼›
```typescript
{
  ExportNamedDeclaration(
    path: NodePath<t.ExportNamedDeclaration>,
    state: PluginPass
  ) {
    const apidoc = state.get("api-doc");
    let _comment: Comment = undefined;
    path.node.leadingComments?.forEach((comment) => {
      if (!Reflect.has(comment, "skip")) {
        const tags = parseComment(comment.value)?.tags;
        _comment = {
          describe:
            tags?.find((v) => v.title === "cDescribe")?.description || "",
          type: tags?.find((v) => v.title === "cType")?.description || "",
          options:
            tags?.find((v) => v.title === "cOptions")?.description || "",
          default:
            tags?.find((v) => v.title === "cDefault")?.description || "",
        };
        Reflect.set(comment, "skip", true);
      }
    });
    apidoc.push({
      attributeName: (path.node.declaration as t.TypeAlias).id.name.substr(1).toLocaleLowerCase(),
      attributeDescribe: _comment!.describe,
      attributeType: _comment!.type,
      attributeOptions: _comment!.options,
      attributeDefault: _comment!.default,
    } as ApiTable);
    state.set("api-doc", apidoc);
  },
}
```
#### 2.5.4 æ³¨é‡Šè§£æå‡½æ•°ï¼š
```typescript
const parseComment = (comment: string) => {
  if (!comment) {
    return;
  }
  return doctrine.parse(comment, {
    unwrap: true,
  });
};
```
#### 2.5.5 Markdownè¡¨æ ¼æ‹¼è£…ï¼š
```typescript
const generateMD = (apidoc: Array<ApiTable>) => {
  let raw = `| å±æ€§å | è¯´æ˜ | ç±»å‹ | å¯é€‰å€¼	| é»˜è®¤å€¼ |\n| ------ | ---- | ---- | ----- | ----- |\n`;
  apidoc.forEach((item) => {
    raw += `| ${item.attributeName} | ${item.attributeDescribe} | ${item.attributeType} | ${item.attributeOptions} | ${item.attributeDefault} |\n`;
  });
  return raw;
};
```
#### 2.5.6ç”Ÿæˆç»“æœå±•ç¤º~
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1666193974084-80fdf03e-5cf5-4cf2-97f6-6b995fbcf716.png#clientId=u8f9d2eb6-0aac-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=334&id=u0fac54cd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=334&originWidth=1383&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35315&status=done&style=stroke&taskId=u46197437-9ce8-4f0f-83b0-f30f611b969&title=&width=1383)
## 3. æ€»ç»“
æ’ä»¶ç”Ÿæˆç›®å‰åŸºæœ¬åŠŸèƒ½å®Œæˆï¼Œæ³¨é‡Šè§£æå¯ä»¥é€šè¿‡Babelçš„æ’ä»¶é€‰é¡¹æ¥å®šä¹‰ä½œä¸ºä¸€ä¸ªæ‰©å±•æ–¹å‘ï¼ŒMDæ–‡ä»¶çš„ç”Ÿæˆå¯ä»¥é€šè¿‡å¯¹åº”å·¥å…·è½¬æ¢ï¼Œæ›´å¤šçš„è¾“å‡ºæ–‡ä»¶ç±»å‹ä¹Ÿå¯ä»¥ä½œä¸ºæ‰©å±•æ–¹å‘ï¼Œæ¬¢è¿å–œæ¬¢ç©è½¬Babelçš„å°ä¼™ä¼´ä¸€èµ·äº¤æµäº¤æµ~
> å·²æ¨é€è‡³GitHubï¼Œæ¬¢è¿å…‹éš†æ¼”ç¤ºï¼š`git clone https://github.com/OSpoon/awesome-examples.git`


* * *

**å¦‚æœçœ‹å®Œè§‰å¾—æœ‰æ”¶è·ï¼Œæ¬¢è¿ç‚¹èµã€è¯„è®ºã€åˆ†äº«æ”¯æŒä¸€ä¸‹ã€‚ä½ çš„æ”¯æŒå’Œè‚¯å®šï¼Œæ˜¯æˆ‘åšæŒå†™ä½œçš„åŠ¨åŠ›~**

æœ€åå¯ä»¥å…³æ³¨æˆ‘@å°é‘«åŒå­¦ã€‚æ¬¢è¿[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡](https://it200.cn/ "https://it200.cn/")[fe-xiaoxin](https://it200.cn/ "https://it200.cn/")äº¤æµï¼Œå…±åŒè¿›æ­¥ï¼ˆè¿˜å¯ä»¥å¸®ä½ **fix**ğŸ›ï¼‰~