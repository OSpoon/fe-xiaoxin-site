---
title: ğŸ“¢åˆ©ç”¨Viteæ’ä»¶åŠ©åŠ›è¯ä¹¦å®‰è£…
date: '2022-11-04 08:58'
sidebar: 'auto'
categories:
 - Vite
tags:
 - æ’ä»¶
 - Vite
---

:::tip
åœ¨ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­è®²è¿°äº†åœ¨å‰ç«¯å¼€å‘æ—¶é€šè¿‡é…ç½®è‡ªç­¾åè¯ä¹¦æ¥å®Œæˆå¿…é¡»ä½¿ç”¨HTTPSåè®®æ‰èƒ½å·¥ä½œçš„åŠŸèƒ½ã€‚é‚£ä¹ˆå½“ä½ åŒæ—¶éœ€è¦åœ¨æ‰‹æœºç«¯é¢„è§ˆçš„æ—¶å€™ï¼Œå¯èƒ½å°±è¦å°†å…¬é’¥è¯ä¹¦ä¹Ÿå®‰è£…åˆ°æ‰‹æœºä¸Šäº†ï¼Œä½†æ— è®ºä½ é€šè¿‡ä»€ä¹ˆæ–¹å¼å°†è¯ä¹¦å‘é€åˆ°æ‰‹æœºä¸­éƒ½ä¸å¦‚æˆ‘å†™çš„è¿™ä¸ª`Vite`æ’ä»¶ä½¿ç”¨ç€æ–¹ä¾¿ï¼Œé‚£ä¹ˆä¸€èµ·æ¥çœ‹ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆåšçš„~
:::

<!-- more -->

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[å°é‘«åŒå­¦](https://it200.cn/)ã€‚ä¸€ä½é•¿æœŸä»äº‹**å‰ç«¯å¼€å‘**çš„ç¼–ç¨‹çˆ±å¥½è€…ï¼Œ**æˆ‘ä¿¡å¥‰ç¼–ç¨‹æœ€é‡è¦çš„æ˜¯åˆ†äº«**ã€‚è¯·è·Ÿéšå°é‘«åŒå­¦çš„æ­¥ä¼ï¼Œä¸€èµ·å¸¦ä½ ç•…æ¸¸ä¸ä¸€æ ·çš„å‰ç«¯ä¸–ç•Œ~

## 1. å‰è¨€
åœ¨ä»¥å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­è®²è¿°äº†åœ¨å‰ç«¯å¼€å‘æ—¶é€šè¿‡é…ç½®è‡ªç­¾åè¯ä¹¦æ¥å®Œæˆå¿…é¡»ä½¿ç”¨HTTPSåè®®æ‰èƒ½å·¥ä½œçš„åŠŸèƒ½ã€‚é‚£ä¹ˆå½“ä½ åŒæ—¶éœ€è¦åœ¨æ‰‹æœºç«¯é¢„è§ˆçš„æ—¶å€™ï¼Œå¯èƒ½å°±è¦å°†å…¬é’¥è¯ä¹¦ä¹Ÿå®‰è£…åˆ°æ‰‹æœºä¸Šäº†ï¼Œä½†æ— è®ºä½ é€šè¿‡ä»€ä¹ˆæ–¹å¼å°†è¯ä¹¦å‘é€åˆ°æ‰‹æœºä¸­éƒ½ä¸å¦‚æˆ‘å†™çš„è¿™ä¸ª`Vite`æ’ä»¶ä½¿ç”¨ç€æ–¹ä¾¿ï¼Œé‚£ä¹ˆä¸€èµ·æ¥çœ‹ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆåšçš„~

## 2. æ·»åŠ è°ƒè¯•Viteç¯å¢ƒé…ç½®
åœ¨Vue.jså¼€å‘æ—¶ä¸€èˆ¬éƒ½åœ¨ç¨‹åºä¸­é€šè¿‡`debugger`å…³é”®å­—æ¥ä¸­æ–­ç¨‹åºè¿›è¡Œè°ƒè¯•å°±å¯ä»¥æå®šå¤§å¤šæ•°çš„é—®é¢˜ï¼Œä½†å¾ˆå°‘ä¼šç›´æ¥æ–­ç‚¹è°ƒè¯•æ„å»ºè„šæœ¬ï¼Œé‚£ä¹ˆè¯·æŒ‰ç…§ä¸‹é¢çš„4æ­¥æ¥é…ç½®è°ƒè¯•ç¯å¢ƒï¼Œä»¥ä¾¿æ›´å¥½çš„å®Œæˆåé¢æ’ä»¶çš„å¼€å‘~

1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºåä¸º`.vscode/launch.json`è°ƒè¯•ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼›
2. åœ¨è°ƒè¯•çª—å£å³ä¸‹è§’ç‚¹å‡»æ·»åŠ é…ç½®ï¼Œå¹¶é€‰æ‹© `Node.jsï¼šLaunch via NPM`ï¼›

![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1667403219976-f2fbe4e0-6ce0-48db-9086-8b80a2276911.png)

3. è°ƒæ•´å¢åŠ çš„ `Launch via NPM` é…ç½®ä»¥é€‚åˆå½“å‰é¡¹ç›®ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1667403232664-697a7d72-8397-4331-b7fd-e0da46446028.png)

4. åœ¨`vite.config.ts`çš„èµ·å§‹ä½ç½®æ‰“æ–­ç‚¹åé€šè¿‡è°ƒè¯•çª—å£è¿è¡Œ `Launch via NPM` é…ç½®ï¼Œè¿è¡ŒæˆåŠŸåå°†åœç•™çš„ç›®æ ‡æ–­ç‚¹å¤„ï¼›

![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1667403255689-66a5efa3-353a-4cc8-820c-b7cd848a521f.png)
åˆ°è¿™é‡Œå°±æˆåŠŸè¿›å…¥æ–­ç‚¹äº†ï¼Œæ€ä¹ˆæ ·ï¼Œä½ é…ç½®å¥½äº†å—~ ğŸ¤º
## 3. Viteæ’ä»¶æ¨¡æ¿åŠåŸºæœ¬é…ç½®
é¦–å…ˆæˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¢åŠ åä¸º`plugins/vite-plugin-certificate-install.ts`çš„æ’ä»¶æ–‡ä»¶ï¼›
```typescript
import type { Plugin, ResolvedConfig, ViteDevServer } from "vite";

export type Options = {
    path: string,
    pem: string,
}

const certificateInstall = (options: Options) => {

  	const { path: _path, pem: _pem } = options;

    let config: ResolvedConfig;

    return {
        // 1ã€æŒ‡å®šæ’ä»¶åç§°
        name: 'vite-plugin-certificate-install',
        // 2ã€æŒ‡å®šæ’ä»¶åœ¨serveæ—¶è¿è¡Œï¼Œé»˜è®¤serveå’Œbuildå‡è¿è¡Œ
        apply(_, { command }) {
            return command === 'serve'
        },
        // 3ã€å­˜å‚¨æœ€ç»ˆè§£æçš„é…ç½®
        configResolved(_config) {
            config = _config
        },
        // 4ã€é…ç½®å¼€å‘æœåŠ¡å™¨é’©å­
        configureServer(server: ViteDevServer) {
            server.middlewares.use((req, res, next) => {

            })
        },
    } as Plugin;
}

export default certificateInstall;
```
æ¥ç€å®‰è£…æ’ä»¶åˆ°`vite.config.ts`ï¼Œ**ts**ç¯å¢ƒå—`tsconfig.json`æ–‡ä»¶é™åˆ¶ï¼Œå¯èƒ½éœ€è¦å°†ç¼–å†™çš„è„šæœ¬æ˜¾ç¤ºçš„æ·»åŠ åˆ°`include`é…ç½®ä¸­ï¼š
```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// 1ã€å¯¼å…¥æ’ä»¶
import certificateInstall from './plugins/vite-plugin-certificate-install';

export default defineConfig({
    plugins: [
        vue(),
        // 2ã€å®‰è£…æ’ä»¶ 
        certificateInstall({ path: './keys', pem: 'agent2.pem' })
    ]
})
```
```json
// tsconfig.node.json
{
  "compilerOptions": {
    "composite": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "allowSyntheticDefaultImports": true
  },
  // æ–°å¢
  "include": ["vite.config.ts", "./plugins/vite-plugin-certificate-install.ts"]
}
```
åˆ°è¿™é‡Œæœ€åŸºç¡€çš„æ’ä»¶å·²ç»å‡†å¤‡å¹¶å®‰è£…å¥½äº†~
## 4. ç¼–å†™å¼€å‘æœåŠ¡å™¨ä¸­é—´ä»¶
**ç¼–ç è¯´æ˜ï¼š**

1. è¯ä¹¦æ–‡ä»¶å—æµè§ˆå™¨å½±å“ç›´æ¥è®¿é—®å¯èƒ½è‡³ä¼šæ¸²æŸ“å‡ºè¯ä¹¦å†…å®¹è€Œä¸èƒ½è§¦å‘ç§»åŠ¨è®¾å¤‡å®‰è£…ã€‚
2. åªè·å–resolvedUrlsä¸­çš„networké€‰é¡¹æ˜¯å› ä¸ºç§»åŠ¨è®¾å¤‡é€šè¿‡ç»Ÿä¸€ç½‘ç»œè¿›è¡Œè·å–ï¼Œlocalåœ°å€å°†æ— æ³•åœ¨ç§»åŠ¨è®¾å¤‡ç›´æ¥è®¿é—®ï¼Œæ‰€ä»¥localå…¼å®¹æ— æ„ä¹‰ã€‚
### 4.1 é‡å†™printUrlså‡½æ•°ï¼š
é‡å†™printUrlså‡½æ•°ï¼Œæ‰©å±•å…¶æ”¯æŒè¾“å‡ºå®‰è£…è¯ä¹¦çš„äºŒç»´ç ï¼›
```json
// ä¿å­˜ä¸€ä»½å†…ç½®çš„printUrlså‡½æ•°ï¼›
const _print = server.printUrls;
// é‡å†™printUrlså‡½æ•°ï¼Œæ‰©å±•åŠŸèƒ½ï¼›
server.printUrls = () => {
    _print();
    // è·å– network ä¸­çš„åœ°å€ç”¨äºåˆæˆurlåç”ŸæˆäºŒç»´ç 
    const host = server.resolvedUrls?.network[0];
    if (host) {
        console.log(`${bold('Install Root Certificate on a Mobile Device â¤¦')}`);
        qrcode.generate(`${host}__certificate/`, { small: true });
    } else {
        console.log(`${green('Failed to get the network address.')}`);
    }
}
```
### 4.2 ç¼–å†™å¼€å‘æœåŠ¡ä¸­é—´ä»¶ï¼š
æ‹¦æˆªæ‰§è¡Œçš„å®‰è£…è¯ä¹¦è¯·æ±‚ï¼Œå¹¶è¯»å–è¯ä¹¦æ–‡ä»¶åå†™å›ç§»åŠ¨è®¾å¤‡ï¼›
```json
server.middlewares.use((req, res, next) => {
    const { method, originalUrl } = req;
    if (method === 'GET' && originalUrl === '/__certificate/') {
        const pemPath = path.resolve(_path, _pem);
        if (!fs.existsSync(pemPath)) throw new Error(`Make sure that '${pemPath}' exists.`);
        const pem = fs.readFileSync(path.resolve(_path, _pem));
        res.writeHead(200, {
            'Content-Type': 'application/octet-stream',
            'Content-Disposition': `filename=${_pem}`,
        })
        res.end(pem);
    } else {
        next();
    }
})
```
### 4.3 å‡†å¤‡ç­¾åæ–‡ä»¶åå¯åŠ¨Viteå¼€å‘æœåŠ¡ï¼š
åœ¨é¡¹ç›®æ ¹ç›®å½•çš„`keys`ç›®å½•ä¸‹æ”¾ç½®`agent2.pem`è¯ä¹¦ï¼Œæ‰§è¡Œ`npm run dev`å¯åŠ¨Viteå¼€å‘æœåŠ¡ï¼š
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1667487256513-14a0d54a-0af7-4cde-a1be-47f7d6d4ace0.png)
## 5. Viteæ’ä»¶æ‰“åŒ…åˆ†å‘
åœ¨æ’ä»¶æ‰“åŒ…æ—¶æˆ‘ä»¬è¿˜æ˜¯è¦è€ƒè™‘åˆ°ä½¿ç”¨è€…éTypeScriptå¼€å‘ç¯å¢ƒï¼Œæ‰€ä»¥éœ€è¦è½¬ä¸ºJavaScriptåè¿›è¡Œåˆ†å‘ï¼Œtsupæ¨¡å—åˆ©ç”¨esbuildåœ¨ä¸éœ€è¦ä»»ä½•é…ç½®çš„æƒ…å†µä¸‹å°±å¯ä»¥å¯¹Tsè¿›è¡Œç¼–è¯‘ã€‚
éœ€è¦åœ¨é¡¹ç›®ä¸­å®‰è£…tsupåˆ°å¼€å‘ä¾èµ–ï¼Œè¯·ä¸è¦ç›´æ¥é€šè¿‡npxä½¿ç”¨ï¼Œå¯èƒ½ä¼šå› ä¸ºæ‰¾ä¸åˆ°typescriptæ¨¡å—è€Œç»ˆæ­¢æ‰éƒ¨åˆ†ç¼–è¯‘æµç¨‹ï¼›
å®‰è£…åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘æ’ä»¶ï¼Œéœ€è¦æŒ‡å®šå…¥å£æ–‡ä»¶ã€å‡ºå£ç›®å½•ã€ç¼–è¯‘.d.tsæ–‡ä»¶ã€è¾“å‡ºæ¨¡å—ç±»å‹é€‰é¡¹ï¼š
```shell
tsup ./plugins/vite-plugin-certificate-install.ts --outDir output --dts --format cjs,esm
```
## 6. åˆ©ç”¨è„šæ‰‹æ¶å¿«é€Ÿæ­å»ºViteæ’ä»¶ï¼š
`generator-vite-plugin`åŸºäºYeomançš„Viteæ’ä»¶ç”Ÿæˆå™¨ï¼š
**å…¨å±€å®‰è£… yeoman å’Œ generator**
```shell
$ npm i -g yo
$ npm i -g generator-vite-plugin
```
**è¿è¡Œç”Ÿæˆå™¨**
```shell
$ yo vite-plugin
```
## 7. æ€»ç»“
åˆ©ç”¨Viteæä¾›çš„å¼€å‘æœåŠ¡å™¨é’©å­ï¼Œæˆ‘ä»¬å®ç°äº†å›ºå®šåœ°å€çš„æ‹¦æˆªï¼Œå¹¶å°†è‡ªç­¾åè¯ä¹¦å†™å›åˆ°æ‰‹æœºç«¯å¹¶è§¦å‘è¯ä¹¦å®‰è£…ã€‚è¿˜é€šè¿‡é‡å†™Viteå†…ç½®çš„printUrlså‡½æ•°å®ç°äº†æœåŠ¡å¯åŠ¨åå°†è¯ä¹¦è·å–åœ°å€çš„äºŒç»´ç æ‰“å°åˆ°ç»ˆç«¯ï¼Œåœ¨æœ€åè¿˜æä¾›äº†`generator-vite-plugin`æ’ä»¶æ¥å¿«é€Ÿç¼–å†™Viteæ’ä»¶ï¼Œæ¬¢è¿ä½“éªŒä½¿ç”¨~

---

**å¦‚æœçœ‹å®Œè§‰å¾—æœ‰æ”¶è·ï¼Œæ¬¢è¿ç‚¹èµã€è¯„è®ºã€åˆ†äº«æ”¯æŒä¸€ä¸‹ã€‚ä½ çš„æ”¯æŒå’Œè‚¯å®šï¼Œæ˜¯æˆ‘åšæŒå†™ä½œçš„åŠ¨åŠ›~**
æœ€åå¯ä»¥å…³æ³¨æˆ‘@å°é‘«åŒå­¦ã€‚æ¬¢è¿[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡](https://juejin.cn/pin/7126196941574111262)[fe-xiaoxin](https://it200.cn/)äº¤æµï¼Œå…±åŒè¿›æ­¥ï¼ˆè¿˜å¯ä»¥å¸®ä½ **fix**ğŸ›ï¼‰~
